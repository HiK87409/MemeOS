import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { FiX, FiCheck, FiRefreshCw, FiSettings, FiPlus, FiTrash2, FiShuffle } from 'react-icons/fi';
import { useTheme } from '../hooks/useTheme';
import InputDialog from './InputDialog';

const CardCustomizer = ({ 
  isOpen, 
  onClose, 
  position, 
  noteId, 
  currentSettings = {},
  onApply,
  onApplyToAll,
  onResetThisCard,
  onResetAllToDefault
}) => {
  // è·å–å½“å‰ä¸»é¢˜é¢œè‰²
  const getThemeColors = () => {
    const computedStyle = getComputedStyle(document.documentElement);
    return {
      text: computedStyle.getPropertyValue('--theme-text').trim() || '#374151',
      textSecondary: computedStyle.getPropertyValue('--theme-text-secondary').trim() || '#6b7280',
      primary: computedStyle.getPropertyValue('--theme-primary').trim() || '#2563eb',
      accent: computedStyle.getPropertyValue('--theme-accent').trim() || '#7c3aed'
    };
  };

  const [settings, setSettings] = useState(() => {
    const themeColors = getThemeColors();
    return {
      borderWidth: 1,
      borderColor: '#e5e7eb',
      shadowSize: 'sm',
      backgroundColor: '#ffffff',
      backgroundGradient: false,
      gradientColors: ['#ffffff', '#f9fafb'],
      borderRadius: 8,
      maxLines: 6,
      // åˆ†å¼€çš„å­—ä½“é¢œè‰²è®¾ç½® - ä½¿ç”¨ä¸»é¢˜é¢œè‰²
      mainTextColor: themeColors.text,      // ä¸»è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ï¼‰
      secondaryTextColor: themeColors.textSecondary, // æ¬¡è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡ç­¾ã€æ—¥æœŸï¼‰
      linkTextColor: themeColors.primary,      // é“¾æ¥æ–‡æœ¬é¢œè‰²
      buttonTextColor: themeColors.primary,    // æŒ‰é’®æ–‡æœ¬é¢œè‰²
      referenceTextColor: themeColors.accent, // å¼•ç”¨æ–‡æœ¬é¢œè‰²
      // ä¿æŒå‘åå…¼å®¹
      textColor: themeColors.text,
      ...currentSettings
    };
  });

  const [previewMode, setPreviewMode] = useState(false);
  const [savedColorSchemes, setSavedColorSchemes] = useState([]);
  const [generatedGradients, setGeneratedGradients] = useState([]);
  const [isResetting, setIsResetting] = useState(false);
  const [showInputDialog, setShowInputDialog] = useState(false);

  useEffect(() => {
    // å¦‚æœæ­£åœ¨é‡ç½®ï¼Œä¸è¦è¦†ç›–è®¾ç½®
    if (isResetting) {
      return;
    }
    
    // åªåœ¨æ‰“å¼€è®¾ç½®é¢æ¿æ—¶æ›´æ–°è®¾ç½®ï¼Œç¡®ä¿åŠ è½½æœ€æ–°é…ç½®
    if (isOpen) {
      console.log('ğŸ”§ [CardCustomizer] è®¾ç½®é¢æ¿æ‰“å¼€ï¼ŒåŠ è½½æœ€æ–°é…ç½®:', currentSettings);
      
      const themeColors = getThemeColors();
      const defaultSettings = {
        borderWidth: 1,
        borderColor: '#e5e7eb',
        shadowSize: 'sm',
        backgroundColor: '#ffffff',
        backgroundGradient: false,
        gradientColors: ['#ffffff', '#f9fafb'],
        borderRadius: 8,
        maxLines: 6,
        // åˆ†å¼€çš„å­—ä½“é¢œè‰²è®¾ç½® - ä½¿ç”¨ä¸»é¢˜é¢œè‰²
        mainTextColor: themeColors.text,      // ä¸»è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ï¼‰
        secondaryTextColor: themeColors.textSecondary, // æ¬¡è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡ç­¾ã€æ—¥æœŸï¼‰
        linkTextColor: themeColors.primary,      // é“¾æ¥æ–‡æœ¬é¢œè‰²
        buttonTextColor: themeColors.primary,    // æŒ‰é’®æ–‡æœ¬é¢œè‰²
        referenceTextColor: themeColors.accent, // å¼•ç”¨æ–‡æœ¬é¢œè‰²
        // ä¿æŒå‘åå…¼å®¹
        textColor: themeColors.text
      };
      
      // åˆå¹¶é»˜è®¤è®¾ç½®å’Œå½“å‰è®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼
      const mergedSettings = {
        ...defaultSettings,
        ...currentSettings
      };
      
      setSettings(mergedSettings);
      console.log('ğŸ”§ [CardCustomizer] è®¾ç½®å·²æ›´æ–°:', mergedSettings);
    }
  }, [currentSettings, isOpen, isResetting]);

  // åŠ è½½ä¿å­˜çš„é…ç½®æ–¹æ¡ˆ
  const loadColorSchemes = async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè·³è¿‡åŠ è½½é…ç½®æ–¹æ¡ˆ');
        setSavedColorSchemes([]);
        return;
      }

      const response = await fetch('/api/notes/color-schemes', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const schemes = await response.json();
        setSavedColorSchemes(schemes || []);
        console.log('é…ç½®æ–¹æ¡ˆåŠ è½½æˆåŠŸ:', schemes);
      } else {
        const errorData = await response.text();
        console.error('åŠ è½½é…ç½®æ–¹æ¡ˆå¤±è´¥:', response.status, errorData);
        
        // ç§»é™¤è®¤è¯é”™è¯¯å¤„ç†ï¼Œé¿å…ç™»å½•åˆæœŸè¯¯åˆ¤å¯¼è‡´é…ç½®æ–¹æ¡ˆè¢«æ¸…ç©º
      }
    } catch (error) {
      console.error('åŠ è½½é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
      setSavedColorSchemes([]);
    }
  };

  useEffect(() => {
    loadColorSchemes();
  }, []);

  // åœ¨è®¾ç½®é¢æ¿æ‰“å¼€æ—¶é‡æ–°åŠ è½½é…ç½®æ–¹æ¡ˆï¼Œé¿å…ç¼“å­˜
  useEffect(() => {
    if (isOpen) {
      console.log('ğŸ”§ [CardCustomizer] è®¾ç½®é¢æ¿æ‰“å¼€ï¼Œé‡æ–°åŠ è½½é…ç½®æ–¹æ¡ˆ');
      loadColorSchemes();
    }
  }, [isOpen]);

  const shadowOptions = [
    { value: 'none', label: 'æ— é˜´å½±', class: 'shadow-none', style: 'none' },
    { value: 'sm', label: 'å°é˜´å½±', class: 'shadow-sm', style: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' },
    { value: 'md', label: 'ä¸­é˜´å½±', class: 'shadow-md', style: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)' },
    { value: 'lg', label: 'å¤§é˜´å½±', class: 'shadow-lg', style: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)' },
    { value: 'xl', label: 'è¶…å¤§é˜´å½±', class: 'shadow-xl', style: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)' },
    { value: '2xl', label: 'å·¨å¤§é˜´å½±', class: 'shadow-2xl', style: '0 25px 50px -12px rgba(0, 0, 0, 0.25)' }
  ];

  const presetColors = [
    '#ffffff', '#f9fafb', '#f3f4f6', '#e5e7eb',
    '#fef2f2', '#fef7f0', '#fffbeb', '#f0fdf4',
    '#ecfdf5', '#f0fdfa', '#ecfeff', '#f0f9ff',
    '#eff6ff', '#f5f3ff', '#faf5ff', '#fdf4ff'
  ];

  const gradientPresets = [
    ['#ffffff', '#f9fafb'],
    ['#fef2f2', '#fef7f0'],
    ['#fffbeb', '#f0fdf4'],
    ['#ecfdf5', '#f0fdfa'],
    ['#ecfeff', '#f0f9ff'],
    ['#eff6ff', '#f5f3ff'],
    ['#faf5ff', '#fdf4ff'],
    ['#e0e7ff', '#c7d2fe']
  ];

  const handleSettingChange = (key, value) => {
    setSettings(prev => ({
      ...prev,
      [key]: value
    }));
  };

  const handleGradientColorChange = (index, color) => {
    const newColors = [...settings.gradientColors];
    newColors[index] = color;
    setSettings(prev => ({
      ...prev,
      gradientColors: newColors
    }));
  };

  const { darkMode } = useTheme();

  // ç”Ÿæˆæ™ºèƒ½æ¸å˜ - ç”Ÿæˆ6ç§ä¸åŒçš„æ¸å˜é…è‰²ä¾›é€‰æ‹©
  const generateSmartGradient = () => {
    const lightGradients = [
      ['#ffecd2', '#fcb69f'], // æ¸©æš–æ©™è‰²
      ['#a8edea', '#fed6e3'], // è–„è·ç²‰è‰²
      ['#d299c2', '#fef9d7'], // ç´«è‰²åˆ°é»„è‰²
      ['#89f7fe', '#66a6ff'], // è“è‰²æ¸å˜
      ['#fdbb2d', '#22c1c3'], // é‡‘è‰²åˆ°é’è‰²
      ['#ff9a9e', '#fecfef'], // ç²‰è‰²æ¸å˜
      ['#a8e6cf', '#dcedc1'], // ç»¿è‰²æ¸å˜
      ['#ffd3a5', '#fd9853'], // æ©™è‰²æ¸å˜
      ['#667eea', '#764ba2'], // ç´«è“æ¸å˜
      ['#f093fb', '#f5576c'], // ç²‰çº¢æ¸å˜
      ['#4facfe', '#00f2fe'], // è“é’æ¸å˜
      ['#43e97b', '#38f9d7'], // ç»¿é’æ¸å˜
      ['#fa709a', '#fee140'], // ç²‰é»„æ¸å˜
      ['#a8caba', '#5d4e75'], // ç»¿ç´«æ¸å˜
      ['#ff6b6b', '#feca57'], // çº¢æ©™æ¸å˜
      ['#48cae4', '#023e8a']  // è“è‰²æ¸å˜
    ];

    const darkGradients = [
      ['#2c3e50', '#34495e'], // æ·±è“ç°
      ['#232526', '#414345'], // æ·±ç°
      ['#1e3c72', '#2a5298'], // æ·±è“
      ['#4b6cb7', '#182848'], // è“è‰²åˆ°æ·±è“
      ['#360033', '#0b8793'], // ç´«è‰²åˆ°é’è‰²
      ['#2c5364', '#203a43'], // æ·±é’è‰²
      ['#0f0c29', '#302b63'], // æ·±ç´«è‰²
      ['#24243e', '#302b63'], // æ·±ç´«ç°
      ['#1a1a2e', '#16213e'], // æ·±è“ç´«
      ['#0f3460', '#0e4b99'], // æ·±è“
      ['#2d1b69', '#11998e'], // ç´«é’æ¸å˜
      ['#8360c3', '#2ebf91'], // ç´«ç»¿æ¸å˜
      ['#ee0979', '#ff6a00'], // çº¢æ©™æ¸å˜
      ['#134e5e', '#71b280'], // æ·±é’ç»¿
      ['#667db6', '#0082c8'], // è“è‰²æ¸å˜
      ['#2193b0', '#6dd5ed']  // é’è“æ¸å˜
    ];

    const gradients = darkMode ? darkGradients : lightGradients;
    
    // éšæœºé€‰æ‹©6ç§ä¸åŒçš„æ¸å˜
    const shuffled = [...gradients].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, 6);
    
    setGeneratedGradients(selected);
  };

  const hexToRgb = (hex) => {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  };

  const rgbToHex = (r, g, b) => {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
  };

  const resetToDefault = () => {
    console.log('ğŸ”„ [CardCustomizer] å¼€å§‹é‡ç½®åˆ°é»˜è®¤è®¾ç½®');
    setIsResetting(true);
    
    // è·å–å½“å‰ä¸»é¢˜çš„surfaceé¢œè‰²ä½œä¸ºé»˜è®¤èƒŒæ™¯è‰²
    const computedStyle = getComputedStyle(document.documentElement);
    const themeSurface = computedStyle.getPropertyValue('--theme-surface').trim();
    
    // ç«‹å³è®¾ç½®é»˜è®¤å€¼
    const defaultSettings = {
      borderWidth: 1,
      borderColor: '#e5e7eb',
      shadowSize: 'sm',
      backgroundColor: themeSurface || '#e2e8f0', // ä½¿ç”¨ä¸»é¢˜surfaceé¢œè‰²ï¼Œfallbackåˆ°æµ…è‰²æ¨¡å¼çš„é»˜è®¤å€¼
      backgroundGradient: false,
      gradientColors: [themeSurface || '#e2e8f0', '#f9fafb'],
      borderRadius: 8,
      maxLines: 6,
      // åˆ†å¼€çš„å­—ä½“é¢œè‰²è®¾ç½®
      mainTextColor: '#374151',      // ä¸»è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ï¼‰
      secondaryTextColor: '#6b7280', // æ¬¡è¦æ–‡æœ¬é¢œè‰²ï¼ˆæ ‡ç­¾ã€æ—¥æœŸï¼‰
      linkTextColor: '#2563eb',      // é“¾æ¥æ–‡æœ¬é¢œè‰²
      buttonTextColor: '#2563eb',    // æŒ‰é’®æ–‡æœ¬é¢œè‰²
      // ä¿æŒå‘åå…¼å®¹
      textColor: '#374151'
    };
    
    setSettings(defaultSettings);
    console.log('ğŸ”„ [CardCustomizer] é»˜è®¤è®¾ç½®å·²åº”ç”¨:', defaultSettings);
    
    // é‡ç½®å®Œæˆåæ¸…é™¤æ ‡å¿—
    setTimeout(() => {
      setIsResetting(false);
      console.log('ğŸ”„ [CardCustomizer] é‡ç½®å®Œæˆ');
    }, 300);
  };

  // ä¿å­˜å½“å‰é…è‰²æ–¹æ¡ˆ
  const saveCurrentColorScheme = async () => {
    if (savedColorSchemes.length >= 10) {
      // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè€Œä¸æ˜¯alert
      return;
    }

    setShowInputDialog(true);
  };

  const handleSaveScheme = async (schemeName) => {
    if (!schemeName) return;

    const token = localStorage.getItem('token');
    if (!token) {
      console.error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œæ— æ³•ä¿å­˜é…ç½®æ–¹æ¡ˆ');
      return;
    }

    const scheme = {
      name: schemeName,
      borderColor: settings.borderColor,
      backgroundColor: settings.backgroundColor,
      backgroundGradient: settings.backgroundGradient,
      gradientColors: [...settings.gradientColors],
      shadowSize: settings.shadowSize,
      borderRadius: settings.borderRadius,
      borderWidth: settings.borderWidth,
      // åˆ†å¼€çš„å­—ä½“é¢œè‰²è®¾ç½®
      mainTextColor: settings.mainTextColor,
      secondaryTextColor: settings.secondaryTextColor,
      linkTextColor: settings.linkTextColor,
      buttonTextColor: settings.buttonTextColor,
      // ä¿æŒå‘åå…¼å®¹
      textColor: settings.textColor
    };

    try {
      const response = await fetch('/api/notes/color-schemes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          name: schemeName,
          schemeData: scheme
        })
      });

      if (response.ok) {
        console.log('é…ç½®æ–¹æ¡ˆä¿å­˜æˆåŠŸ');
        // é‡æ–°åŠ è½½é…ç½®æ–¹æ¡ˆåˆ—è¡¨
        loadColorSchemes();
      } else {
        const errorData = await response.text();
        let errorMessage = 'ä¿å­˜é…è‰²æ–¹æ¡ˆå¤±è´¥';
        try {
          const errorJson = JSON.parse(errorData);
          errorMessage = errorJson.error || errorMessage;
        } catch (e) {
          // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
        }
        console.error('ä¿å­˜é…è‰²æ–¹æ¡ˆå¤±è´¥:', response.status, errorMessage);
      }
    } catch (error) {
      console.error('ä¿å­˜é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
    }
  };

  // åº”ç”¨é…ç½®æ–¹æ¡ˆ
  const applyColorScheme = (scheme) => {
    setSettings(prev => ({
      ...prev,
      borderColor: scheme.borderColor,
      backgroundColor: scheme.backgroundColor,
      backgroundGradient: scheme.backgroundGradient,
      gradientColors: [...scheme.gradientColors],
      shadowSize: scheme.shadowSize,
      borderRadius: scheme.borderRadius,
      borderWidth: scheme.borderWidth,
      // åˆ†å¼€çš„å­—ä½“é¢œè‰²è®¾ç½®ï¼ˆå‘åå…¼å®¹ï¼‰
      mainTextColor: scheme.mainTextColor || scheme.textColor || '#374151',
      secondaryTextColor: scheme.secondaryTextColor || scheme.textColor || '#6b7280',
      linkTextColor: scheme.linkTextColor || scheme.textColor || '#2563eb',
      buttonTextColor: scheme.buttonTextColor || scheme.textColor || '#2563eb',
      referenceTextColor: scheme.referenceTextColor || scheme.textColor || '#7c3aed',
      // ä¿æŒå‘åå…¼å®¹
      textColor: scheme.textColor || '#374151'
    }));
  };

  // åˆ é™¤é…ç½®æ–¹æ¡ˆ
  const handleDeleteScheme = async (schemeId) => {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        console.error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œæ— æ³•åˆ é™¤é…ç½®æ–¹æ¡ˆ');
        return;
      }

      const response = await fetch(`/api/notes/color-schemes/${schemeId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        console.log('é…ç½®æ–¹æ¡ˆåˆ é™¤æˆåŠŸ');
        // é‡æ–°åŠ è½½é…ç½®æ–¹æ¡ˆåˆ—è¡¨
        await loadColorSchemes();
      } else {
        const errorData = await response.text();
        console.error('åˆ é™¤é…ç½®æ–¹æ¡ˆå¤±è´¥:', response.status, errorData);
      }
    } catch (error) {
      console.error('åˆ é™¤é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
    }
  };

  const getPreviewStyle = () => {
    const shadowOption = shadowOptions.find(s => s.value === settings.shadowSize);
    const style = {
      borderWidth: `${settings.borderWidth}px`,
      borderColor: settings.borderColor,
      borderStyle: 'solid',
      borderRadius: `${settings.borderRadius}px`,
      boxShadow: shadowOption?.style === 'none' ? 'none' : shadowOption?.style || '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
      color: settings.textColor
    };

    if (settings.backgroundGradient) {
      style.background = `linear-gradient(135deg, ${settings.gradientColors[0]}, ${settings.gradientColors[1]})`;
    } else {
      style.backgroundColor = settings.backgroundColor;
    }

    return style;
  };

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[10000] flex items-center justify-center">
      {/* èƒŒæ™¯é®ç½© */}
      <div 
        className="absolute inset-0 bg-black bg-opacity-50"
        onClick={onClose}
      />
      
      {/* è®¾ç½®é¢æ¿ */}
      <div 
        className="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-card-customizer min-w-card-customizer max-w-card-customizer mx-4 max-h-[90vh] flex flex-col"
        style={{
          backgroundColor: 'var(--theme-surface)',
          border: '1px solid var(--theme-border)'
        }}
      >
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-4 border-b" style={{ borderColor: 'var(--theme-border)' }}>
          <div className="flex items-center gap-2">
            <FiSettings size={18} style={{ color: 'var(--theme-text)' }} />
            <h3 className="text-lg font-semibold" style={{ color: 'var(--theme-text)' }}>  
              å¡ç‰‡ä¸ªæ€§åŒ–è®¾ç½®
            </h3>
          </div>
          <button
            onClick={onClose}
            className="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            style={{ color: 'var(--theme-text-secondary)' }}
          >
            <FiX size={18} />
          </button>
        </div>

        {/* é¢„è§ˆåŒºåŸŸ - è¶…ç´§å‡‘å¸ƒå±€ */}
        <div className="p-2 border-b flex-shrink-0 h-card-preview overflow-hidden" style={{ borderColor: 'var(--theme-border)' }}>
          <div className="text-xs font-medium mb-1" style={{ color: 'var(--theme-text)' }}>
            é¢„è§ˆæ•ˆæœ
          </div>
          <div 
            className="p-2 rounded text-xs"
            style={getPreviewStyle()}
          >
            <div className="font-medium mb-0.5 truncate" style={{ color: 'var(--theme-text)' }}>
              ç¤ºä¾‹ç¬”è®°æ ‡é¢˜
            </div>
            <div 
              className="mb-1 leading-tight"
              style={{ 
                color: 'var(--theme-text-secondary)',
                display: '-webkit-box',
                WebkitLineClamp: 2, // å›ºå®šæ˜¾ç¤º2è¡Œ
                WebkitBoxOrient: 'vertical',
                overflow: 'hidden',
                lineHeight: '1.3',
                fontSize: '0.7rem'
              }}
            >
              è¿™æ˜¯ç¤ºä¾‹å†…å®¹ï¼Œç”¨äºé¢„è§ˆå¡ç‰‡æ ·å¼æ•ˆæœã€‚
            </div>
            {/* åº•éƒ¨æ ‡ç­¾åŒºåŸŸé¢„è§ˆ */}
            <div className="flex justify-between items-center">
              <div className="text-xs" style={{ color: 'var(--theme-text-secondary)', fontSize: '0.6rem' }}>
                è¡Œæ•°: {settings.maxLines}
              </div>
              <span className="text-xs px-1 py-0.5 rounded bg-blue-100 text-blue-800" style={{ fontSize: '0.6rem' }}>æ ‡ç­¾</span>
            </div>
          </div>
        </div>

        {/* è®¾ç½®é€‰é¡¹ - ä¼˜åŒ–æ»šåŠ¨ */}
        <div 
          className="p-3 space-y-4 flex-1 overflow-y-auto"
          style={{
            maxHeight: 'calc(90vh - 280px)', // ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ»šåŠ¨ç©ºé—´
            scrollbarWidth: 'thin', /* Firefox */
            scrollbarColor: 'var(--theme-border) transparent'
          }}
        >
          {/* è¾¹æ¡†å®½åº¦ã€åœ†è§’å¤§å°ã€é»˜è®¤æ˜¾ç¤ºè¡Œæ•° - ä¸‰åˆ—ç´§å‡‘å¸ƒå±€ */}
          <div className="grid grid-cols-3 gap-3">
            <div>
              <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
                è¾¹æ¡†å®½åº¦
              </label>
              <input
                type="range"
                min="0"
                max="5"
                value={settings.borderWidth}
                onChange={(e) => handleSettingChange('borderWidth', parseInt(e.target.value))}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(settings.borderWidth / 5) * 100}%, #e5e7eb ${(settings.borderWidth / 5) * 100}%, #e5e7eb 100%)`
                }}
              />
              <div className="text-sm mt-1 text-center font-medium" style={{ color: 'var(--theme-text-secondary)' }}>
                {settings.borderWidth}px
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
                åœ†è§’å¤§å°
              </label>
              <input
                type="range"
                min="0"
                max="20"
                value={settings.borderRadius}
                onChange={(e) => handleSettingChange('borderRadius', parseInt(e.target.value))}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(settings.borderRadius / 20) * 100}%, #e5e7eb ${(settings.borderRadius / 20) * 100}%, #e5e7eb 100%)`
                }}
              />
              <div className="text-sm mt-1 text-center font-medium" style={{ color: 'var(--theme-text-secondary)' }}>
                {settings.borderRadius}px
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
                é»˜è®¤æ˜¾ç¤ºè¡Œæ•°
              </label>
              <input
                type="range"
                min="1"
                max="10"
                value={settings.defaultLines}
                onChange={(e) => handleSettingChange('defaultLines', parseInt(e.target.value))}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${((settings.defaultLines - 1) / 9) * 100}%, #e5e7eb ${((settings.defaultLines - 1) / 9) * 100}%, #e5e7eb 100%)`
                }}
              />
              <div className="text-sm mt-1 text-center font-medium" style={{ color: 'var(--theme-text-secondary)' }}>
                {settings.defaultLines}è¡Œ
              </div>
            </div>
          </div>

          {/* è¾¹æ¡†é¢œè‰²å’ŒèƒŒæ™¯é¢œè‰² - ä¸€è¡Œæ˜¾ç¤º */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
                è¾¹æ¡†é¢œè‰²
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="color"
                  value={settings.borderColor}
                  onChange={(e) => handleSettingChange('borderColor', e.target.value)}
                  className="w-6 h-6 rounded border"
                />
                <input
                  type="text"
                  value={settings.borderColor}
                  onChange={(e) => handleSettingChange('borderColor', e.target.value)}
                  className="flex-1 px-2 py-1 text-sm border rounded"
                  style={{
                    backgroundColor: 'var(--theme-surface)',
                    borderColor: 'var(--theme-border)',
                    color: 'var(--theme-text)'
                  }}
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
                èƒŒæ™¯é¢œè‰²
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="color"
                  value={settings.backgroundColor}
                  onChange={(e) => handleSettingChange('backgroundColor', e.target.value)}
                  className="w-6 h-6 rounded border"
                  disabled={settings.backgroundGradient}
                />
                <input
                  type="text"
                  value={settings.backgroundColor}
                  onChange={(e) => handleSettingChange('backgroundColor', e.target.value)}
                  className="flex-1 px-2 py-1 text-sm border rounded"
                  style={{
                    backgroundColor: 'var(--theme-surface)',
                    borderColor: 'var(--theme-border)',
                    color: 'var(--theme-text)'
                  }}
                  disabled={settings.backgroundGradient}
                />
              </div>
            </div>
          </div>

          {/* é˜´å½±è®¾ç½® */}
          <div>
            <label className="block text-sm font-medium mb-2" style={{ color: 'var(--theme-text)' }}>
              é˜´å½±å¤§å°
            </label>
            <div className="flex items-center gap-2">
              {shadowOptions.map((option, index) => (
                <button
                  key={option.value}
                  onClick={() => handleSettingChange('shadowSize', option.value)}
                  className={`w-8 h-8 text-sm rounded border transition-colors flex items-center justify-center ${
                    settings.shadowSize === option.value 
                      ? 'bg-blue-500 text-white border-blue-500' 
                      : 'border-gray-300 hover:bg-gray-50'
                  }`}
                  style={{
                    backgroundColor: settings.shadowSize === option.value ? '#3b82f6' : 'var(--theme-surface)',
                    borderColor: settings.shadowSize === option.value ? '#3b82f6' : 'var(--theme-border)',
                    color: settings.shadowSize === option.value ? 'white' : 'var(--theme-text)'
                  }}
                  title={option.label}
                >
                  {index}
                </button>
              ))}
            </div>
          </div>

          {/* èƒŒæ™¯è®¾ç½® */}
          <div>
            <label className="block text-sm font-medium mb-3" style={{ color: 'var(--theme-text)' }}>
              èƒŒæ™¯ç±»å‹
            </label>

            {/* èƒŒæ™¯ç±»å‹é€‰æ‹© */}
            <div className="flex items-center gap-4 mb-4">
              <div className="flex items-center gap-2">
                <input
                  type="radio"
                  id="solid-bg"
                  name="backgroundType"
                  checked={!settings.backgroundGradient}
                  onChange={() => handleSettingChange('backgroundGradient', false)}
                  className="rounded"
                />
                <label htmlFor="solid-bg" className="text-sm" style={{ color: 'var(--theme-text)' }}>
                  çº¯è‰²èƒŒæ™¯
                </label>
              </div>
              <div className="flex items-center gap-2">
                <input
                  type="radio"
                  id="gradient-bg"
                  name="backgroundType"
                  checked={settings.backgroundGradient}
                  onChange={() => handleSettingChange('backgroundGradient', true)}
                  className="rounded"
                />
                <label htmlFor="gradient-bg" className="text-sm" style={{ color: 'var(--theme-text)' }}>
                  æ¸å˜èƒŒæ™¯
                </label>
              </div>
            </div>

            {/* æ¸å˜èƒŒæ™¯è®¾ç½® */}
            {settings.backgroundGradient && (
              <div>
                <div className="ml-6">
                  {/* æ™ºèƒ½æ¸å˜å’Œæ‰‹åŠ¨è®¾ç½®çš„å¸ƒå±€ */}
                  <div className="grid grid-cols-2 gap-4 mb-3">
                    {/* å·¦ä¾§ï¼šæ™ºèƒ½æ¸å˜ */}
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-medium" style={{ color: 'var(--theme-text)' }}>æ™ºèƒ½é…è‰²</span>
                        <button
                          onClick={generateSmartGradient}
                          className="flex items-center gap-1 px-2 py-1 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded hover:from-purple-600 hover:to-pink-600 transition-all duration-200 transform hover:scale-105"
                          title={`ç”Ÿæˆ${darkMode ? 'æ·±è‰²ç³»' : 'æµ…è‰²ç³»'}éšæœºæ¸å˜`}
                        >
                          <FiShuffle size={10} />
                          ç”Ÿæˆ
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-1">
                        {generatedGradients.map((gradient, index) => {
                          const isSelected = settings.gradientColors[0] === gradient[0] && settings.gradientColors[1] === gradient[1];
                          return (
                            <button
                              key={index}
                              onClick={() => handleSettingChange('gradientColors', gradient)}
                              className={`h-8 rounded border hover:scale-105 transition-transform relative ${
                                isSelected ? 'border-blue-500 border-2' : 'border-gray-300'
                              }`}
                              style={{ 
                                background: `linear-gradient(135deg, ${gradient[0]}, ${gradient[1]})` 
                              }}
                              title={`${gradient[0]} â†’ ${gradient[1]}`}
                            >
                              {isSelected && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                  <div className="w-4 h-4 bg-white rounded-full flex items-center justify-center shadow-md">
                                    <svg className="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                    </svg>
                                  </div>
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* å³ä¾§ï¼šæ‰‹åŠ¨è®¾ç½® */}
                    <div>
                      <span className="text-xs font-medium mb-2 block" style={{ color: 'var(--theme-text)' }}>æ‰‹åŠ¨è®¾ç½®</span>
                      <div className="space-y-2">
                        <div className="flex items-center gap-1">
                          <span className="text-xs w-6" style={{ color: 'var(--theme-text-secondary)' }}>èµ·å§‹</span>
                          <input
                            type="color"
                            value={settings.gradientColors[0]}
                            onChange={(e) => handleGradientColorChange(0, e.target.value)}
                            className="w-5 h-5 rounded border"
                          />
                          <input
                            type="text"
                            value={settings.gradientColors[0]}
                            onChange={(e) => handleGradientColorChange(0, e.target.value)}
                            className="flex-1 px-1 py-0.5 text-xs border rounded"
                            style={{
                              backgroundColor: 'var(--theme-surface)',
                              borderColor: 'var(--theme-border)',
                              color: 'var(--theme-text)'
                            }}
                          />
                        </div>
                        <div className="flex items-center gap-1">
                          <span className="text-xs w-6" style={{ color: 'var(--theme-text-secondary)' }}>ç»“æŸ</span>
                          <input
                            type="color"
                            value={settings.gradientColors[1]}
                            onChange={(e) => handleGradientColorChange(1, e.target.value)}
                            className="w-5 h-5 rounded border"
                          />
                          <input
                            type="text"
                            value={settings.gradientColors[1]}
                            onChange={(e) => handleGradientColorChange(1, e.target.value)}
                            className="flex-1 px-1 py-0.5 text-xs border rounded"
                            style={{
                              backgroundColor: 'var(--theme-surface)',
                              borderColor: 'var(--theme-border)',
                              color: 'var(--theme-text)'
                            }}
                          />
                        </div>
                      </div>
                </div>
              </div>
            </div>
          </div>
          

          {/* å­—ä½“é¢œè‰²è®¾ç½® */}
          <div className="space-y-3">
            <label className="block text-sm font-medium" style={{ color: 'var(--theme-text)' }}>
              å­—ä½“é¢œè‰²è®¾ç½®
            </label>
            
            {/* ç´§å‡‘çš„ä¸¤åˆ—å¸ƒå±€ */}
            <div className="grid grid-cols-2 gap-3">
              {/* ä¸»è¦æ–‡æœ¬é¢œè‰² */}
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                  ä¸»è¦æ–‡æœ¬ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ï¼‰
                </label>
                <div className="flex items-center gap-2">
                  <input
                    type="color"
                    value={settings.mainTextColor}
                    onChange={(e) => handleSettingChange('mainTextColor', e.target.value)}
                    className="w-6 h-6 rounded border"
                  />
                  <input
                    type="text"
                    value={settings.mainTextColor}
                    onChange={(e) => handleSettingChange('mainTextColor', e.target.value)}
                    className="flex-1 px-2 py-1 text-sm border rounded"
                    style={{
                      backgroundColor: 'var(--theme-surface)',
                      borderColor: 'var(--theme-border)',
                      color: 'var(--theme-text)'
                    }}
                  />
                </div>
              </div>

              {/* æ¬¡è¦æ–‡æœ¬é¢œè‰² */}
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                  æ¬¡è¦æ–‡æœ¬ï¼ˆæ ‡ç­¾ã€æ—¥æœŸï¼‰
                </label>
                <div className="flex items-center gap-2">
                  <input
                    type="color"
                    value={settings.secondaryTextColor}
                    onChange={(e) => handleSettingChange('secondaryTextColor', e.target.value)}
                    className="w-6 h-6 rounded border"
                  />
                  <input
                    type="text"
                    value={settings.secondaryTextColor}
                    onChange={(e) => handleSettingChange('secondaryTextColor', e.target.value)}
                    className="flex-1 px-2 py-1 text-sm border rounded"
                    style={{
                      backgroundColor: 'var(--theme-surface)',
                      borderColor: 'var(--theme-border)',
                      color: 'var(--theme-text)'
                    }}
                  />
                </div>
              </div>

              {/* é“¾æ¥æ–‡æœ¬é¢œè‰² */}
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                  é“¾æ¥æ–‡æœ¬
                </label>
                <div className="flex items-center gap-2">
                  <input
                    type="color"
                    value={settings.linkTextColor}
                    onChange={(e) => handleSettingChange('linkTextColor', e.target.value)}
                    className="w-6 h-6 rounded border"
                  />
                  <input
                    type="text"
                    value={settings.linkTextColor}
                    onChange={(e) => handleSettingChange('linkTextColor', e.target.value)}
                    className="flex-1 px-2 py-1 text-sm border rounded"
                    style={{
                      backgroundColor: 'var(--theme-surface)',
                      borderColor: 'var(--theme-border)',
                      color: 'var(--theme-text)'
                    }}
                  />
                </div>
              </div>

              {/* æŒ‰é’®æ–‡æœ¬é¢œè‰² */}
              <div>
                <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                  æŒ‰é’®æ–‡æœ¬ï¼ˆå±•å¼€/æ”¶èµ·ï¼‰
                </label>
                <div className="flex items-center gap-2">
                  <input
                    type="color"
                    value={settings.buttonTextColor}
                    onChange={(e) => handleSettingChange('buttonTextColor', e.target.value)}
                    className="w-6 h-6 rounded border"
                  />
                  <input
                    type="text"
                    value={settings.buttonTextColor}
                    onChange={(e) => handleSettingChange('buttonTextColor', e.target.value)}
                    className="flex-1 px-2 py-1 text-sm border rounded"
                    style={{
                      backgroundColor: 'var(--theme-surface)',
                      borderColor: 'var(--theme-border)',
                      color: 'var(--theme-text)'
                    }}
                  />
                </div>
              </div>
            </div>

            {/* å¼•ç”¨æ–‡æœ¬é¢œè‰² - å•ç‹¬ä¸€è¡Œ */}
            <div>
              <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                å¼•ç”¨æ–‡æœ¬ï¼ˆ[[ç¬”è®°é“¾æ¥]]ï¼‰
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="color"
                  value={settings.referenceTextColor}
                  onChange={(e) => handleSettingChange('referenceTextColor', e.target.value)}
                  className="w-6 h-6 rounded border"
                />
                <input
                  type="text"
                  value={settings.referenceTextColor}
                  onChange={(e) => handleSettingChange('referenceTextColor', e.target.value)}
                  className="flex-1 px-2 py-1 text-sm border rounded"
                  style={{
                    backgroundColor: 'var(--theme-surface)',
                    borderColor: 'var(--theme-border)',
                    color: 'var(--theme-text)'
                  }}
                />
              </div>
            </div>

            {/* å¿«é€Ÿé¢œè‰²é€‰æ‹© */}
            <div>
              <label className="block text-sm font-medium mb-1" style={{ color: 'var(--theme-text-secondary)' }}>
                å¿«é€Ÿé€‰æ‹©
              </label>
              <div className="grid grid-cols-8 gap-1">
                {[
                  '#000000', '#374151', '#6b7280', '#9ca3af',
                  '#dc2626', '#ea580c', '#d97706', '#65a30d',
                  '#059669', '#0891b2', '#2563eb', '#7c3aed',
                  '#c026d3', '#e11d48', '#be123c', '#7f1d1d'
                ].map(color => {
                  const isSelected = settings.mainTextColor === color;
                  return (
                    <button
                      key={color}
                      onClick={() => {
                        // ç‚¹å‡»æ—¶åº”ç”¨åˆ°æ‰€æœ‰æ–‡æœ¬é¢œè‰²
                        handleSettingChange('mainTextColor', color);
                        handleSettingChange('secondaryTextColor', color);
                        handleSettingChange('linkTextColor', color);
                        handleSettingChange('buttonTextColor', color);
                        handleSettingChange('referenceTextColor', color);
                        handleSettingChange('textColor', color); // ä¿æŒå‘åå…¼å®¹
                      }}
                      className={`w-5 h-5 rounded border hover:scale-110 transition-transform relative ${isSelected ? 'border-blue-500 border-2' : 'border-gray-300'}`}
                      style={{ backgroundColor: color }}
                      title={`åº”ç”¨ ${color} åˆ°æ‰€æœ‰æ–‡æœ¬`}
                    >
                      {isSelected && (
                        <div className="absolute inset-0 flex items-center justify-center">
                          <div className="w-3 h-3 bg-white rounded-full flex items-center justify-center shadow-sm">
                            <svg className="w-2 h-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                          </div>
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>



          {/* é…ç½®æ–¹æ¡ˆä¿å­˜ */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="text-sm font-medium" style={{ color: 'var(--theme-text)' }}>
                é…ç½®æ–¹æ¡ˆ
              </label>
              <button
                onClick={saveCurrentColorScheme}
                disabled={savedColorSchemes.length >= 10}
                className={`flex items-center gap-1 px-2 py-1 text-xs rounded transition-colors ${
                  savedColorSchemes.length >= 10 
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                    : 'bg-green-500 text-white hover:bg-green-600'
                }`}
                title={savedColorSchemes.length >= 10 ? 'æœ€å¤šä¿å­˜10ä¸ªé…ç½®æ–¹æ¡ˆ' : 'ä¿å­˜å½“å‰é…ç½®'}
              >
                <FiPlus size={12} />
                ä¿å­˜é…ç½®
              </button>
            </div>
            
            {savedColorSchemes.length > 0 && (
              <div className="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto">
                {savedColorSchemes.map(scheme => {
                  // åˆ¤æ–­å½“å‰è®¾ç½®æ˜¯å¦ä¸æ­¤é…è‰²æ–¹æ¡ˆåŒ¹é…
                  const isCurrentScheme = 
                    settings.backgroundColor === scheme.backgroundColor &&
                    settings.backgroundGradient === scheme.backgroundGradient &&
                    settings.gradientColors[0] === scheme.gradientColors[0] &&
                    settings.gradientColors[1] === scheme.gradientColors[1] &&
                    settings.borderColor === scheme.borderColor &&
                    settings.borderWidth === scheme.borderWidth &&
                    settings.mainTextColor === scheme.mainTextColor &&
                    settings.secondaryTextColor === scheme.secondaryTextColor;
                  
                  return (
                    <div key={scheme.id} className="relative group">
                      {/* é…è‰²é¢„è§ˆæŒ‰é’® */}
                      <button
                        onClick={() => applyColorScheme(scheme)}
                        className={`w-full h-8 rounded border hover:scale-105 transition-transform relative ${isCurrentScheme ? 'border-blue-500 border-2' : 'border-gray-300'}`}
                        style={{
                          backgroundColor: scheme.backgroundGradient 
                            ? undefined 
                            : scheme.backgroundColor,
                          background: scheme.backgroundGradient 
                            ? `linear-gradient(135deg, ${scheme.gradientColors[0]}, ${scheme.gradientColors[1]})` 
                            : undefined,
                        }}
                        title={`${scheme.name} - ç‚¹å‡»åº”ç”¨æ­¤é…ç½®`}
                      >
                        {/* å¯¹å‹¾æ ‡è¯† */}
                        {isCurrentScheme && (
                          <div className="absolute inset-0 flex items-center justify-center">
                            <div className="w-4 h-4 bg-white rounded-full flex items-center justify-center shadow-md">
                              <svg className="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                              </svg>
                            </div>
                          </div>
                        )}
                      </button>
                      
                      {/* åˆ é™¤æŒ‰é’® - æ‚¬åœæ—¶æ˜¾ç¤º */}
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleDeleteScheme(scheme.id);
                        }}
                        className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                        title={`åˆ é™¤é…ç½®æ–¹æ¡ˆ: ${scheme.name}`}
                      >
                        <svg className="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                        </svg>
                      </button>
                      
                      {/* é…è‰²åç§° - æ‚¬åœæ—¶æ˜¾ç¤º */}
                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                        {scheme.name}
                        {isCurrentScheme && <span className="text-blue-300 ml-1">(å½“å‰)</span>}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            
            {savedColorSchemes.length === 0 && (
              <div 
                className="text-xs text-center py-4 border-2 border-dashed rounded"
                style={{ 
                  color: 'var(--theme-text-secondary)',
                  borderColor: 'var(--theme-border)'
                }}
              >
                æš‚æ— ä¿å­˜çš„é…ç½®æ–¹æ¡ˆ
              </div>
            )}
          </div>
        </div>

        {/* åº•éƒ¨æŒ‰é’® - ç´§å‡‘å¸ƒå±€ */}
        <div className="flex items-center justify-between px-3 py-2 border-t flex-shrink-0" style={{ borderColor: 'var(--theme-border)' }}>
          <div className="flex gap-1.5">
            <button
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ”„ [CardCustomizer] ç‚¹å‡»"æ¢å¤æ­¤å¡ç‰‡"æŒ‰é’®');
                if (onResetThisCard) {
                  // ç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œç¡®è®¤å¼¹çª—åœ¨NoteCardä¸­å¤„ç†
                  onResetThisCard();
                } else {
                  // å¦åˆ™åªé‡ç½®æœ¬åœ°çŠ¶æ€ï¼Œä¹Ÿéœ€è¦ç¡®è®¤
                  console.log('ğŸ”„ [CardCustomizer] isResettingçŠ¶æ€:', isResetting);
                  resetToDefault();
                }
              }}
              disabled={isResetting}
              className={`flex items-center gap-1 px-2 py-1.5 text-xs transition-colors rounded ${isResetting ? 'text-gray-400 cursor-not-allowed' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100 cursor-pointer'}`}
              style={{ 
                color: isResetting ? '#9ca3af' : 'var(--theme-text-secondary)',
                pointerEvents: isResetting ? 'none' : 'auto'
              }}
            >
              <FiRefreshCw size={12} className={isResetting ? 'animate-spin' : ''} />
              {isResetting ? 'æ¢å¤ä¸­' : 'æ¢å¤æ­¤å¡ç‰‡'}
            </button>
            
            {onResetAllToDefault && (
              <button
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('ğŸ”„ [CardCustomizer] ç‚¹å‡»"å…¨éƒ¨æ¢å¤é»˜è®¤"æŒ‰é’®');
                  onResetAllToDefault();
                }}
                className="flex items-center gap-1 px-2 py-1.5 text-xs text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors cursor-pointer rounded"
                title="åˆ é™¤æ‰€æœ‰ç¬”è®°çš„ä¸ªæ€§åŒ–è®¾ç½®ï¼Œæ¢å¤åˆ°é»˜è®¤çŠ¶æ€"
              >
                <FiTrash2 size={12} />
                å…¨éƒ¨æ¢å¤
              </button>
            )}
          </div>
          
          <div className="flex gap-1.5">
            <button
              onClick={() => {
                console.log('ğŸ¨ [CardCustomizer] ç‚¹å‡»"åº”ç”¨åˆ°æ­¤å¡ç‰‡"æŒ‰é’®, settings:', settings);
                onApply(settings);
              }}
              className="flex items-center gap-1 px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
            >
              <FiCheck size={12} />
              åº”ç”¨æ­¤å¡ç‰‡
            </button>
            <button
              onClick={() => {
                console.log('ğŸŒ [CardCustomizer] ç‚¹å‡»"åº”ç”¨åˆ°å…¨éƒ¨"æŒ‰é’®, settings:', settings);
                onApplyToAll(settings);
              }}
              className="flex items-center gap-1 px-3 py-1.5 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors"
            >
              <FiCheck size={12} />
              åº”ç”¨å…¨éƒ¨
            </button>
          </div>
        </div>
      </div>
      
      {/* è¾“å…¥å¯¹è¯æ¡† */}
      <InputDialog
        isOpen={showInputDialog}
        onClose={() => setShowInputDialog(false)}
        onConfirm={handleSaveScheme}
        title="ä¿å­˜é…ç½®æ–¹æ¡ˆ"
        placeholder="è¯·è¾“å…¥é…ç½®æ–¹æ¡ˆåç§°"
        maxLength={20}
      />
    </div>,
    document.body
  );
};

export default CardCustomizer;